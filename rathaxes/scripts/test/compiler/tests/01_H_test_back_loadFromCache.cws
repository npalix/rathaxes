/*
	TEST for template codeworker generation
*/

#include  "01_G_test_back_registerToCache.cws"

#include "rtxTpl/rtxResolve.inc.cws"

// Load the two templates :
// First, hash the prototype, then find every template matching it,
// And finally reduce the selection to only one template before loading.

// Build the rtype node for the template
local theRtype;
local name;
local params;
rtxNodeIdentifier(name, "open", "Userland");
rtxNodeRType(theRtype, name, params);
pushItem params;
rtxNodeIdentifier(params#back, "Context");

local theWith;
local theTemplates;

if (rtxLink_findTemplates(theRtype, theTemplates) == false)
    error("01_H_test_back_loadFromCache.cws:"
          +" The template could not be found by rtxLink.");
traceLine("A list of " + getArraySize(theTemplates)
          + " templates was found matching the prototype '"
          + theProto + "'");

if (rtxLink_selectUniqueTemplate(theTemplates, theWith) == false)
    error("01_H_test_back_loadFromCache.cws:"
          +" rtxLink could not select an unique template :"+toString(theTemplates, true));
traceLine("An Unique template could be identified for resolution.");

local theChunk;
if (rtxLink_selectChunkFromTemplate(theTemplates, "::CALL", theChunk) == false)
    error("01_H_test_back_loadFromCache.cws:"
          +" rtxLink could not find a '::CALL' chunk in template "
          +rtxRTypeName<theRtype.type>(theRtype));
traceLine("The chunk '::CALL' was found for the template.");

traceLine("Loading template : Userland::open(Context ctx)...");
local c_tree;
if (rtxLink_LoadItem(theChunk, c_tree) == false)
    error("01_H_test_back_loadFromCache.cws: Could not load script for chunk"
          + " 'CALL' for template "+rtxRTypeName<theRtype.type>(theRtype));

traceLine("====>Codeworker Script and tree Loaded with success.");
